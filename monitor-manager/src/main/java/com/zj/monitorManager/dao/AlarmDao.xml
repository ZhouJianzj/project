<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zj.monitorManager.dao.AlarmDao">

<!--    插入报警信息，如果sensor_id存在则变为修改-->
    <insert id="insertAlarm" parameterType="com.zj.monitorManager.entity.Alarm">
        insert into
	        t_alarm(sensor_id, currentValue, alarmMsg,isHandled,alarmTime)
        VALUES
            (#{sensorId},#{currentValue},#{alarmMsg},#{isHandled},#{alarmTime})
        on duplicate key update
 	        currentValue=#{currentValue},isHandled=#{isHandled},
                                alarmMsg=#{alarmMsg},alarmTime=now()
    </insert>
<!--查询传感器以及对应的传感器模型-->
    <resultMap id="sensorResultMap" type="com.zj.monitorManager.entity.Sensor">
        <id column="id" property="id"/>
        <result column="sensorName" property="sensorName"/>
        <result column="protocal" property="protocal"/>
        <result column="sensorCode" property="sensorCode"/>
<!--        项目-->
        <association property="item" javaType="com.zj.monitorManager.entity.Item">
            <id column="itemId" property="id"/>
            <result column="itemName" property="name"/>
<!--            项目所属的组织-->
            <association property="organize" javaType="com.zj.monitorManager.entity.Organize">
                <id column="orgaId" property="id"/>
                <result column="orgaName" property="name"/>
            </association>
        </association>
<!--        传感器模型对象-->
        <association property="sensorModel" javaType="com.zj.monitorManager.entity.SensorModel">
            <id column="mid" property="id"/>
            <result column="deviceType" property="deviceType"/>
            <result column="dataPointName" property="dataPointName"/>
            <result column="lowThreshold" property="lowThreshold"/>
            <result column="highThreshold" property="highThreshold"/>
        </association>
    </resultMap>
    <select id="selectSensor" resultMap="sensorResultMap">
        select s.id,
               s.sensorName,
               s.protocal,
               s.sensorCode,

               it.id as itemId,
               it.name as itemName,

               o.id  as orgaId,
               o.name as orgaName,

               sm.id as mid,
               sm.deviceType,
               sm.dataPointName,
               sm.lowThreshold,
               sm.highThreshold
        from t_sensor s
            left join t_sensor_model sm on sm.id = s.sensorModel_id
            left join t_item it on s.item_id = it.id
            left join organize o on  o.id = it.orga_id
    </select>

    <select id="selectSensorModelById" resultType="com.zj.monitorManager.entity.SensorModel">
        select * from t_sensor_model where id = #{sensorModelId}
    </select>
</mapper>